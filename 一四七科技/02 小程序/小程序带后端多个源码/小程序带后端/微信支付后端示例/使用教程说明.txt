
项目地址：https://github.com/leancloud/weapp-pay-getting-started

小程序微信支付「后端商户系统」。配合 LeanCloud 小程序 SDK 快速实现小程序微信支付功能。
部署配置环境变量
开始之前，请确保已经按照下面的步骤完成了环境变量的配置：
进入应用控制台 - 云引擎 - 设置
设置应用的二级域名并保存
添加并保存以下环境变量
WEIXIN_APPID：小程序 AppId
WEIXIN_MCHID：微信支付商户号
WEIXIN_PAY_SECRET：微信支付 API 密钥（微信商户平台 - 账户设置 - API安全 - 密钥设置）
WEIXIN_NOTIFY_URL：https://{{yourdomain}}.leanapp.cn/weixin/pay-callback，其中 yourdomain 是第二步中设置的二级域名


Example
本地开发
首先确认本机已经安装 Node.js 运行环境和 LeanCloud 命令行工具，然后执行下列指令：
[AppleScript] 纯文本查看 复制代码
?
1
2
$ git clone [url]https://github.com/leancloud/weapp-pay-getting-started.git[/url]
$ cd weapp-pay-getting-started
安装依赖：
[AppleScript] 纯文本查看 复制代码
?
1
npm install
登录并关联应用：
[AppleScript] 纯文本查看 复制代码
?
1
2
lean login
lean checkout
启动项目：
[AppleScript] 纯文本查看 复制代码
?
1
lean up
之后你就可以在 localhost:3001 调试云函数了。
部署
部署到预备环境（若无预备环境则直接部署到生产环境）：
[AppleScript] 纯文本查看 复制代码
?
1
lean deploy
支付流程
登录用户在小程序客户端通过 JavaScript SDK 调用名为 order 的云函数下单。
order 函数调用微信支付统一下单 API，创建「预订单」并保存在 Order 表中，返回签名过的预订单信息。
在小程序客户端调用支付 API，传入 2 中返回的预订单信息，发起支付。
支付成功后，微信通知 /weixin/pay-callback 支付成功，pay-callback 将对应的 order 状态更新为 SUCCESS。